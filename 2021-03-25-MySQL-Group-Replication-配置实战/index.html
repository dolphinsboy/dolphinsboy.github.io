<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="MySQL," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="背景从MySQL5.7.17就开始支持Group Replication，以MySQL插件的模式，支持单主、多主更新，自动分区恢复、冲突检测等特性，其主要好处如下：  自动剔除故障节点 提供容错机制 支持多节点更新 自动组配置管理（处理宕机、故障以及重连接） 提供高可用复制数据库  本文主要测试如何配置、单主和多主区别、多主数据更新冲突等。">
<meta name="keywords" content="MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL-Group-Replication-配置实战">
<meta property="og:url" content="http://dolphinsboy.github.io/2021-03-25-MySQL-Group-Replication-配置实战/index.html">
<meta property="og:site_name" content="Guosong">
<meta property="og:description" content="背景从MySQL5.7.17就开始支持Group Replication，以MySQL插件的模式，支持单主、多主更新，自动分区恢复、冲突检测等特性，其主要好处如下：  自动剔除故障节点 提供容错机制 支持多节点更新 自动组配置管理（处理宕机、故障以及重连接） 提供高可用复制数据库  本文主要测试如何配置、单主和多主区别、多主数据更新冲突等。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-03-31T09:34:15.672Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL-Group-Replication-配置实战">
<meta name="twitter:description" content="背景从MySQL5.7.17就开始支持Group Replication，以MySQL插件的模式，支持单主、多主更新，自动分区恢复、冲突检测等特性，其主要好处如下：  自动剔除故障节点 提供容错机制 支持多节点更新 自动组配置管理（处理宕机、故障以及重连接） 提供高可用复制数据库  本文主要测试如何配置、单主和多主区别、多主数据更新冲突等。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://dolphinsboy.github.io/2021-03-25-MySQL-Group-Replication-配置实战/"/>





  <title>MySQL-Group-Replication-配置实战 | Guosong</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Guosong</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-blogs">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            好文
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dolphinsboy.github.io/2021-03-25-MySQL-Group-Replication-配置实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guosong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guosong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL-Group-Replication-配置实战</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-25T11:11:08+08:00">
                2021-03-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2021-03-25-MySQL-Group-Replication-配置实战/" class="leancloud_visitors" data-flag-title="MySQL-Group-Replication-配置实战">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>从MySQL5.7.17就开始支持Group Replication，以MySQL插件的模式，支持单主、多主更新，自动分区恢复、冲突检测等特性，其主要好处如下：</p>
<ul>
<li>自动剔除故障节点</li>
<li>提供容错机制</li>
<li>支持多节点更新</li>
<li>自动组配置管理（处理宕机、故障以及重连接）</li>
<li>提供高可用复制数据库</li>
</ul>
<p>本文主要测试如何配置、单主和多主区别、多主数据更新冲突等。</p>
<a id="more"></a>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><h3 id="MySQL基础配置"><a href="#MySQL基础配置" class="headerlink" title="MySQL基础配置"></a>MySQL基础配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gtid-mode                = ON</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">master_info_repository      =   TABLE</span><br><span class="line">relay_log_info_repository   =   TABLE</span><br><span class="line">transaction_write_set_extraction = MURMUR32</span><br><span class="line">binlog_checksum                  = NONE</span><br><span class="line">log-slave-updates              = 1</span><br></pre></td></tr></table></figure>
<h3 id="组复制配置"><a href="#组复制配置" class="headerlink" title="组复制配置"></a>组复制配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#-------------- group replication ---------------</span><br><span class="line">plugin_load_add=&apos;group_replication.so&apos;</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;0f1ec2e6-db7f-11ea-9773-38f9d35e8343&quot;</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= &quot;qbj3-mysql-test7:15729&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;qbj3-mysql-test7:15729,qbj3-mysql-test8:15729,qbj3-mysql-test13:15729&quot;</span><br><span class="line">loose-group_replication_bootstrap_group=off</span><br></pre></td></tr></table></figure>
<p>具体参数含义参照<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-configuring-instances.html" target="_blank" rel="external">官方文档</a></p>
<h3 id="授权配置"><a href="#授权配置" class="headerlink" title="授权配置"></a>授权配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_USER=&apos;replica&apos;, MASTER_PASSWORD=&apos;eHnNCaQE3ND&apos;  FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br></pre></td></tr></table></figure>
<p>权限配置在8.0上版本表现不同，具体参照<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-user-credentials.html" target="_blank" rel="external">官方文档</a></p>
<h3 id="开启MGR单主模式"><a href="#开启MGR单主模式" class="headerlink" title="开启MGR单主模式"></a>开启MGR单主模式</h3><p><strong>默认是单主的模式</strong></p>
<h4 id="在Server1上执行"><a href="#在Server1上执行" class="headerlink" title="在Server1上执行"></a>在Server1上执行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_replication_bootstrap_group=<span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">START</span> GROUP_REPLICATION;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_replication_bootstrap_group=<span class="keyword">OFF</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Configure this server to bootstrap the group. This option must only be set on one server and only when starting the group for the first time or restarting the entire group. After the group has been bootstrapped, set this option to OFF. It should be set to OFF both dynamically and in the configuration files. Starting two servers or restarting one server with this option set while the group is running may lead to an artificial split brain situation, where two independent groups with the same name are bootstrapped.</p>
</blockquote>
<p>这个参数只能在一台服务器上配置，并且只能在首次启动组或者重新启动整个组时进行设置。组引导完成之后，将此设置为OFF，否则容易导致分裂。搭建测试的时候，在每台服务器都执行这个命令生成三个组。</p>
<h4 id="在Server2和Server3上执行"><a href="#在Server2和Server3上执行" class="headerlink" title="在Server2和Server3上执行"></a>在Server2和Server3上执行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">START</span> <span class="keyword">REPLICATION</span>;</span><br></pre></td></tr></table></figure>
<h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 3daf3191-78a5-11ea-88da-f8bc124417c4 | qbj3-mysql-test7  |        5729 | ONLINE       |</span><br><span class="line">| group_replication_applier | f65c1f31-d0b2-11ea-a245-90b11c503899 | qbj3-mysql-test13 |        5729 | RECOVERING   |</span><br><span class="line">| group_replication_applier | f72f4b43-d0b1-11ea-8ef4-c81f66f4e97a | qbj3-mysql-test8  |        5729 | RECOVERING   |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><strong>历史遗留的环境，其他两个merbers一致处于recover的状态。重新reset master之后，然后重新设置组复制。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 3daf3191-78a5-11ea-88da-f8bc124417c4 | qbj3-mysql-test7  |        5729 | ONLINE       |</span><br><span class="line">| group_replication_applier | f65c1f31-d0b2-11ea-a245-90b11c503899 | qbj3-mysql-test13 |        5729 | ONLINE       |</span><br><span class="line">| group_replication_applier | f72f4b43-d0b1-11ea-8ef4-c81f66f4e97a | qbj3-mysql-test8  |        5729 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.replication_group_member_stats\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                      CHANNEL_NAME: group_replication_applier</span><br><span class="line">                           VIEW_ID: 15971212520128575:3</span><br><span class="line">                         MEMBER_ID: 3daf3191-78a5-11ea-88da-f8bc124417c4</span><br><span class="line">       COUNT_TRANSACTIONS_IN_QUEUE: 0</span><br><span class="line">        COUNT_TRANSACTIONS_CHECKED: 0</span><br><span class="line">          COUNT_CONFLICTS_DETECTED: 0</span><br><span class="line">COUNT_TRANSACTIONS_ROWS_VALIDATING: 0</span><br><span class="line">TRANSACTIONS_COMMITTED_ALL_MEMBERS: 0f1ec2e6-db7f-11ea-9773-38f9d35e8343:1-3</span><br><span class="line">    LAST_CONFLICT_FREE_TRANSACTION:</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">+----+-------------+-----------+--------------------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">| Id | User        | Host      | db                 | Command | Time | State                                                  | Info             |</span><br><span class="line">+----+-------------+-----------+--------------------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">| 73 | root        | localhost | performance_schema | Query   |    0 | starting                                               | show processlist |</span><br><span class="line">| 76 | system user |           | NULL               | Connect |  142 | executing                                              | NULL             |</span><br><span class="line">| 79 | system user |           | NULL               | Connect |  142 | Slave has read all relay log; waiting for more updates | NULL             |</span><br><span class="line">+----+-------------+-----------+--------------------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="开启多线程复制"><a href="#开启多线程复制" class="headerlink" title="开启多线程复制"></a>开启多线程复制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slave_parallel_type=&apos;logical_clock&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global slave_parallel_workers=4;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">+-----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">| Id  | User        | Host      | db   | Command | Time | State                                                  | Info             |</span><br><span class="line">+-----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">| 104 | system user |           | NULL | Connect | 6634 | executing                                              | NULL             |</span><br><span class="line">| 107 | system user |           | NULL | Connect |   19 | Slave has read all relay log; waiting for more updates | NULL             |</span><br><span class="line">| 108 | system user |           | NULL | Connect |   19 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 109 | system user |           | NULL | Connect | 6634 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 110 | system user |           | NULL | Connect | 6634 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 111 | system user |           | NULL | Connect | 6634 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 176 | root        | localhost | test | Sleep   |   19 |                                                        | NULL             |</span><br><span class="line">| 177 | root        | localhost | NULL | Query   |    0 | starting                                               | show processlist |</span><br><span class="line">+-----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name from  performance_schema.threads order by name;</span><br><span class="line">+----------------------------------------------+</span><br><span class="line">| name                                         |</span><br><span class="line">+----------------------------------------------+</span><br><span class="line">| thread/group_rpl/THD_applier_module_receiver |</span><br><span class="line">| thread/group_rpl/THD_certifier_broadcast     |</span><br><span class="line">| thread/innodb/buf_dump_thread                |</span><br><span class="line">| thread/innodb/dict_stats_thread              |</span><br><span class="line">| thread/innodb/io_ibuf_thread                 |</span><br><span class="line">| thread/innodb/io_log_thread                  |</span><br><span class="line">| thread/innodb/io_read_thread                 |</span><br><span class="line">| thread/innodb/io_read_thread                 |</span><br><span class="line">| thread/innodb/io_read_thread                 |</span><br><span class="line">| thread/innodb/io_read_thread                 |</span><br><span class="line">| thread/innodb/io_write_thread                |</span><br><span class="line">| thread/innodb/io_write_thread                |</span><br><span class="line">| thread/innodb/io_write_thread                |</span><br><span class="line">| thread/innodb/io_write_thread                |</span><br><span class="line">| thread/innodb/page_cleaner_thread            |</span><br><span class="line">| thread/innodb/srv_error_monitor_thread       |</span><br><span class="line">| thread/innodb/srv_lock_timeout_thread        |</span><br><span class="line">| thread/innodb/srv_master_thread              |</span><br><span class="line">| thread/innodb/srv_monitor_thread             |</span><br><span class="line">| thread/innodb/srv_purge_thread               |</span><br><span class="line">| thread/innodb/srv_worker_thread              |</span><br><span class="line">| thread/innodb/srv_worker_thread              |</span><br><span class="line">| thread/innodb/srv_worker_thread              |</span><br><span class="line">| thread/sql/compress_gtid_table               |</span><br><span class="line">| thread/sql/main                              |</span><br><span class="line">| thread/sql/one_connection                    |</span><br><span class="line">| thread/sql/signal_handler                    |</span><br><span class="line">| thread/sql/slave_sql                         |</span><br><span class="line">| thread/sql/thread_timer_notifier             |</span><br><span class="line">+----------------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="多主库模式"><a href="#多主库模式" class="headerlink" title="多主库模式"></a>多主库模式</h3><ul>
<li>在第一台服务器上配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">set global group_replication_single_primary_mode=0;</span><br><span class="line">set global slave_preserve_commit_order = 1;</span><br><span class="line">START GROUP_REPLICATION;</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br></pre></td></tr></table></figure>
<ul>
<li>在另外两台服务器上配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set global group_replication_single_primary_mode=0;</span><br><span class="line">set global slave_preserve_commit_order = 1;</span><br><span class="line">START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>
<ul>
<li>状态校验</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 3daf3191-78a5-11ea-88da-f8bc124417c4 | qbj3-mysql-test7  |        5729 | ONLINE       |</span><br><span class="line">| group_replication_applier | f65c1f31-d0b2-11ea-a245-90b11c503899 | qbj3-mysql-test13 |        5729 | ONLINE       |</span><br><span class="line">| group_replication_applier | f72f4b43-d0b1-11ea-8ef4-c81f66f4e97a | qbj3-mysql-test8  |        5729 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.replication_group_member_stats;</span><br><span class="line">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | VIEW_ID             | MEMBER_ID                            | COUNT_TRANSACTIONS_IN_QUEUE | COUNT_TRANSACTIONS_CHECKED | COUNT_CONFLICTS_DETECTED | COUNT_TRANSAC|</span><br><span class="line">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+--------------+</span><br><span class="line">| group_replication_applier | 16166521384465852:3 | 3daf3191-78a5-11ea-88da-f8bc124417c4 |                           0 |                          0 |                        0 |              |</span><br><span class="line">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="读写测试"><a href="#读写测试" class="headerlink" title="读写测试"></a>读写测试</h2><h3 id="单主模式"><a href="#单主模式" class="headerlink" title="单主模式"></a>单主模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%group_replication_single_primary_mode%&apos;;</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">| Variable_name                         | Value |</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">| group_replication_single_primary_mode | ON    |</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode=0;</span><br><span class="line">ERROR 3093 (HY000): Cannot change into or from single primary mode while Group Replication is running.</span><br></pre></td></tr></table></figure>
<h3 id="创建无主键的表"><a href="#创建无主键的表" class="headerlink" title="创建无主键的表"></a>创建无主键的表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t(id int);</span><br><span class="line">Query OK, 0 rows affected (0.13 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t values(100);</span><br><span class="line">ERROR 3098 (HY000): The table does not comply with the requirements by an external plugin.</span><br></pre></td></tr></table></figure>
<p><strong>无主键表可以创建，但是不能插入数据，具体报错如上</strong></p>
<h3 id="创建有主键的表"><a href="#创建有主键的表" class="headerlink" title="创建有主键的表"></a>创建有主键的表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table gr(id int ,name  varchar(10),primary key(id));</span><br><span class="line">Query OK, 0 rows affected (0.13 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into gr values(1, &apos;test&apos;);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<h3 id="创建唯一键的表"><a href="#创建唯一键的表" class="headerlink" title="创建唯一键的表"></a>创建唯一键的表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t(id int,unique key(id));</span><br><span class="line">Query OK, 0 rows affected (0.13 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: t</span><br><span class="line">Create Table: CREATE TABLE `t` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  UNIQUE KEY `id` (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t values(1);</span><br><span class="line">ERROR 3098 (HY000): The table does not comply with the requirements by an external plugin.</span><br><span class="line">mysql&gt; drop table t;</span><br><span class="line">Query OK, 0 rows affected (0.08 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table t(id int not null,unique key(id));</span><br><span class="line">Query OK, 0 rows affected (0.13 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t values(1);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<p>唯一键必须为非null</p>
<h3 id="多主模式下插入测试"><a href="#多主模式下插入测试" class="headerlink" title="多主模式下插入测试"></a>多主模式下插入测试</h3><p>使用tmux同时提交</p>
<h4 id="同时insert"><a href="#同时insert" class="headerlink" title="同时insert"></a>同时insert</h4><ul>
<li>server1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into t values(11);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>server2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into t values(11);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;11&apos; for key &apos;id&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>server3</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into t values(11);</span><br><span class="line">ERROR 3101 (HY000): Plugin instructed the server to rollback the current transaction.</span><br></pre></td></tr></table></figure>
<h4 id="同时update"><a href="#同时update" class="headerlink" title="同时update"></a>同时update</h4><ul>
<li>server1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">update t set id=100 where id=10;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<ul>
<li>server2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">update t set id=100 where id=10;</span><br><span class="line">commit;</span><br><span class="line">ERROR 3101 (HY000): Plugin instructed the server to rollback the current transaction.</span><br></pre></td></tr></table></figure>
<ul>
<li>server3</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">update t set id=100 where id=10;</span><br><span class="line">commit;</span><br><span class="line">ERROR 3101 (HY000): Plugin instructed the server to rollback the current transaction.</span><br></pre></td></tr></table></figure>
<p>可以看到update都可以进入prepare状态，使用乐观执行的模式，但是在commit的时候会判断冲突，然后回滚。</p>
<h4 id="多主自增主键测试"><a href="#多主自增主键测试" class="headerlink" title="多主自增主键测试"></a>多主自增主键测试</h4><ul>
<li>server1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%auto_increment%&apos;;</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">| Variable_name                              | Value     |</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">| auto_increment_increment                   | 7         |</span><br><span class="line">| auto_increment_offset                      | 572911156 |</span><br><span class="line">| group_replication_auto_increment_increment | 7         |</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">insert into t values(NULL);</span><br></pre></td></tr></table></figure>
<ul>
<li>server2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%auto_increment%&apos;;</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">| Variable_name                              | Value     |</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">| auto_increment_increment                   | 7         |</span><br><span class="line">| auto_increment_offset                      | 572911203 |</span><br><span class="line">| group_replication_auto_increment_increment | 7         |</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">insert into t values(NULL);</span><br></pre></td></tr></table></figure>
<ul>
<li>server3</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%auto_increment%&apos;;</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">| Variable_name                              | Value     |</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">| auto_increment_increment                   | 7         |</span><br><span class="line">| auto_increment_offset                      | 572911131 |</span><br><span class="line">| group_replication_auto_increment_increment | 7         |</span><br><span class="line">+--------------------------------------------+-----------+</span><br><span class="line">insert into t values(NULL);</span><br></pre></td></tr></table></figure>
<p>auto_increment_offset(起始值)默认是使用server id值。MGR最多只支持9个，所以一般这个auto_increment_increment(步长)设置为7就够用了。</p>
<ul>
<li>插入测试</li>
</ul>
<p>在以上三个server先后顺序分别执行insert操作，最后t表中的数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  4 |</span><br><span class="line">|  9 |</span><br><span class="line">| 14 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure>
<p>使用tmux的同时执行模拟，产生的数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">| 16 |</span><br><span class="line">| 18 |</span><br><span class="line">| 21 |</span><br><span class="line">+----+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: t</span><br><span class="line">Create Table: CREATE TABLE `t` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8mb4</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>看着并没有使用严格group_replication_auto_increment_increment递增，表象和三个客户端不同时间插入完全不同。<br>更多关于组复制的自增参照<a href="https://mysqlhighavailability.com/mysql-group-replication-auto-increment-configuration-handling/" target="_blank" rel="external">这里</a></p>
<h3 id="MGR-日志"><a href="#MGR-日志" class="headerlink" title="MGR 日志"></a>MGR 日志</h3><p>查看错误日志,发宣布当前Leader以及Follower</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2020-08-11T04:47:32.029858Z 84 [Note] Plugin group_replication reported: &apos;This server is working as primary member.&apos;</span><br><span class="line"></span><br><span class="line">2020-08-11T04:47:44.029189Z 69 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address qbj3-mysql-test7:5729.&apos;</span><br></pre></td></tr></table></figure>
<p>这里对应primary member以及secondary member。</p>
<h3 id="MGR要求和限制"><a href="#MGR要求和限制" class="headerlink" title="MGR要求和限制"></a>MGR要求和限制</h3><h4 id="要求"><a href="#要求" class="headerlink" title="要求"></a><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-requirements.html" target="_blank" rel="external">要求</a></h4><p><strong>基本要求</strong></p>
<ul>
<li>InnoDB 存储引擎，通过参数disable_storage_engines进行设置</li>
<li>表必须有主键，或者非null的唯一键</li>
<li>只支持IPv4网络</li>
<li>网络性能，组复制部署在服务器实例彼此非常接近的集群环境中，并受到网络延迟和网络带宽的影响。</li>
</ul>
<p><strong>服务器配置</strong></p>
<ul>
<li>开启二进制日志，指定log_bin</li>
<li>从库开启更新记录，log_slave_updates</li>
<li>二进制日志行格式，binlog_format=ROW</li>
<li>开启GTID</li>
<li>复制信息记录表，设置master_info_repository=TABLE以及relay_log_info_repository=TABLE</li>
<li>事务Write-Set，设置transaction_write_set_extraction=XXHASH64,write set基于每个的主键</li>
<li>表名设置大小写无关，lower_case_table_names=1</li>
<li>开启并行复制，设置slave_parallel_type=LOGICAL_CLOCK，slave_parallel_workers=N,slave_preserve_commit_order=1</li>
</ul>
<h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-limitations.html" target="_blank" rel="external">限制</a></h4><ul>
<li>组复制认证不考虑Gap Locks</li>
<li>认证过程不考虑表锁以及命名锁</li>
<li>binlog-checksum=NONE</li>
<li>多主模式不支持序列化（SERIALIZABLE）</li>
<li>多主模式不支持对同一个表同时执行DDL，在同一个表并发执行DML有冲突风险但是不检测</li>
<li>多主模式导致死锁，例如select…for update可能会导致死锁，lock各个组成员之间不共享</li>
<li>Replication Filters 不支持</li>
<li>组成员大小限制为9，超过这个就是拒绝，为了保证网络稳定</li>
<li>限制事务大小，例如在sqoop批量导入的时候容易产生大事务</li>
</ul>
<h3 id="故障模拟"><a href="#故障模拟" class="headerlink" title="故障模拟"></a>故障模拟</h3><p><strong>停止一台实例而且还是主实例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 3daf3191-78a5-11ea-88da-f8bc124417c4 | qbj3-mysql-test7  |        5729 | ONLINE       |</span><br><span class="line">| group_replication_applier | f65c1f31-d0b2-11ea-a245-90b11c503899 | qbj3-mysql-test13 |        5729 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021-01-28T09:26:06.843045Z 0 [Warning] Plugin group_replication reported: &apos;Members removed from the group: qbj3-mysql-test8:5729&apos;</span><br><span class="line">2021-01-28T09:26:06.843100Z 0 [Note] Plugin group_replication reported: &apos;Primary server with address qbj3-mysql-test8:5729 left the group. Electing new Primary.&apos;</span><br><span class="line">2021-01-28T09:26:06.843280Z 0 [Note] Plugin group_replication reported: &apos;A new primary with address qbj3-mysql-test7:5729 was elected, enabling conflict detection until the new primary appli &apos;</span><br><span class="line">2021-01-28T09:26:06.851776Z 269 [Note] Plugin group_replication reported: &apos;This server is working as primary member.&apos;</span><br><span class="line">2021-01-28T09:26:06.851905Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to qbj3-mysql-test7:5729, qbj3-mysql-test13:5729 on view 16118256858604912:7.&apos;</span><br><span class="line">2021-01-28T09:26:54.444961Z 248 [Note] Plugin group_replication reported: &apos;Primary had applied all relay logs, disabled conflict detection&apos;</span><br></pre></td></tr></table></figure>
<p>发生切换，选择出新的主库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into t values(12);</span><br><span class="line">ERROR 1290 (HY000): The MySQL server is running with the --super-read-only option so it cannot execute this statement</span><br></pre></td></tr></table></figure>
<p>在单主模式下切换后，有的节点是只读的。针对单主模式的访问需要区分哪个是主节点。</p>
<h3 id="DDL操作"><a href="#DDL操作" class="headerlink" title="DDL操作"></a>DDL操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table t add COLUMN c int after id;</span><br><span class="line">Query OK, 0 rows affected (0.34 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: t</span><br><span class="line">Create Table: CREATE TABLE `t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `c` int(11) DEFAULT NULL,</span><br><span class="line">  UNIQUE KEY `id` (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>多主模式使用tmux同时执行DDL，不会报错，都会执行成功，但是只是执行一个DDL，符合逻辑的需求。</p>
<h3 id="GTID"><a href="#GTID" class="headerlink" title="GTID"></a>GTID</h3><p>组内所有实例使用相同的UUID用于记录GTID。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">loose-group_replication_group_name=&quot;0f1ec2e6-db7f-11ea-9773-38f9d35e8343&quot;</span><br><span class="line"></span><br><span class="line">mysql&gt; show master status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000004</span><br><span class="line">         Position: 453</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set: 0f1ec2e6-db7f-11ea-9773-38f9d35e8343:1-101299:1000009-1000014</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>使用组名和事务ID组成GTID，组内全局唯一。组内事务记录到binlog中是不冲突。<br>这么做有什么好处呢？</p>
<h3 id="问题点"><a href="#问题点" class="headerlink" title="问题点"></a>问题点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST     | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 3daf3191-78a5-11ea-88da-f8bc124417c4 | tdxy-paas-test7 |        5729 | ERROR        |</span><br><span class="line">+---------------------------+--------------------------------------+-----------------+-------------+--------------+</span><br><span class="line">mysql&gt; show master status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000004</span><br><span class="line">         Position: 7970</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set: 0f1ec2e6-db7f-11ea-9773-38f9d35e8343:1-101313:1000009-1000024:2000015-2000023</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>在测试的时候，遇到上面的问题，查看相关日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2021-03-25T07:18:44.877457Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to tdxy-paas-test7:5729 on view 16166521384465852:4.&apos;</span><br><span class="line">2021-03-25T07:18:44.899362Z 361 [ERROR] Slave SQL for channel &apos;group_replication_applier&apos;: Worker 1 failed executing transaction &apos;0f1ec2e6-db7f-11ea-9773-38f9d35e8343:2000024&apos;; Error &apos;Duplica</span><br><span class="line">te column name &apos;a&apos;&apos; on query. Default database: &apos;test&apos;. Query: &apos;alter table t add column a int&apos;, Error_code: 1060</span><br><span class="line">2021-03-25T07:18:44.899471Z 360 [ERROR] Plugin group_replication reported: &apos;The applier thread execution was aborted. Unable to process more transactions, this member will now leave the group</span><br><span class="line">.&apos;</span><br><span class="line">2021-03-25T07:18:44.899532Z 357 [ERROR] Plugin group_replication reported: &apos;Fatal error during execution on the Applier process of Group Replication. The server will now leave the group.&apos;</span><br><span class="line">2021-03-25T07:18:44.899592Z 357 [ERROR] Plugin group_replication reported: &apos;The server was automatically set into read only mode after an error was detected.&apos;</span><br><span class="line">2021-03-25T07:18:44.899823Z 360 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread with &quot;SLAVE START&quot;. We stopped at log &apos;FIRST&apos; position</span><br><span class="line"> 78.</span><br><span class="line">2021-03-25T07:18:44.900019Z 357 [Note] Plugin group_replication reported: &apos;Going to wait for view modification&apos;</span><br><span class="line">2021-03-25T07:18:48.429153Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed: This member has left the group.&apos;</span><br><span class="line">2021-03-25T07:18:48.429266Z 357 [Note] Plugin group_replication reported: &apos;The group replication applier thread was killed&apos;</span><br></pre></td></tr></table></figure>
<p>问题在于执行两个alter table语句导致错误，尽管在执行的时候没有报错，但是导致MGR中的同步中断。</p>
<p>处理的方式是跳过这条binlog，然后再按照多主的模式重启组复制。</p>
<h2 id="单主模式和多主模式切换"><a href="#单主模式和多主模式切换" class="headerlink" title="单主模式和多主模式切换"></a>单主模式和多主模式切换</h2><p>group_replication_single_primary_mode 组复制运行时， 不能手动更改值 。在MySQL 8.0.13中，您可以使用 group_replication_switch_to_single_primary_mode() 和 group_replication_switch_to_multi_primary_mode() UDF在组复制仍在运行时将组从一种模式移至另一种模式。这些UDF管理更改组模式的过程，并确保数据的安全性和一致性。</p>
<h2 id="相关参考"><a href="#相关参考" class="headerlink" title="相关参考"></a>相关参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/128461028" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/128461028</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1438724" target="_blank" rel="external">https://cloud.tencent.com/developer/article/1438724</a></li>
<li><a href="https://codeleading.com/article/75303165534/" target="_blank" rel="external">https://codeleading.com/article/75303165534/</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021-03-23-HDFS机架感知配置/" rel="next" title="HDFS机架感知配置">
                <i class="fa fa-chevron-left"></i> HDFS机架感知配置
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021-03-26-MySQL-Group-Replication架构/" rel="prev" title="MySQL-Group-Replication架构">
                MySQL-Group-Replication架构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Guosong" />
          <p class="site-author-name" itemprop="name">Guosong</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">208</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建"><span class="nav-number">2.</span> <span class="nav-text">搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL基础配置"><span class="nav-number">2.1.</span> <span class="nav-text">MySQL基础配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组复制配置"><span class="nav-number">2.2.</span> <span class="nav-text">组复制配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权配置"><span class="nav-number">2.3.</span> <span class="nav-text">授权配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启MGR单主模式"><span class="nav-number">2.4.</span> <span class="nav-text">开启MGR单主模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在Server1上执行"><span class="nav-number">2.4.1.</span> <span class="nav-text">在Server1上执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在Server2和Server3上执行"><span class="nav-number">2.4.2.</span> <span class="nav-text">在Server2和Server3上执行</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#校验"><span class="nav-number">2.5.</span> <span class="nav-text">校验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启多线程复制"><span class="nav-number">2.6.</span> <span class="nav-text">开启多线程复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程"><span class="nav-number">2.7.</span> <span class="nav-text">线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多主库模式"><span class="nav-number">2.8.</span> <span class="nav-text">多主库模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#读写测试"><span class="nav-number">3.</span> <span class="nav-text">读写测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#单主模式"><span class="nav-number">3.1.</span> <span class="nav-text">单主模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建无主键的表"><span class="nav-number">3.2.</span> <span class="nav-text">创建无主键的表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建有主键的表"><span class="nav-number">3.3.</span> <span class="nav-text">创建有主键的表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建唯一键的表"><span class="nav-number">3.4.</span> <span class="nav-text">创建唯一键的表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多主模式下插入测试"><span class="nav-number">3.5.</span> <span class="nav-text">多主模式下插入测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#同时insert"><span class="nav-number">3.5.1.</span> <span class="nav-text">同时insert</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#同时update"><span class="nav-number">3.5.2.</span> <span class="nav-text">同时update</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多主自增主键测试"><span class="nav-number">3.5.3.</span> <span class="nav-text">多主自增主键测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MGR-日志"><span class="nav-number">3.6.</span> <span class="nav-text">MGR 日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MGR要求和限制"><span class="nav-number">3.7.</span> <span class="nav-text">MGR要求和限制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#要求"><span class="nav-number">3.7.1.</span> <span class="nav-text">要求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#限制"><span class="nav-number">3.7.2.</span> <span class="nav-text">限制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障模拟"><span class="nav-number">3.8.</span> <span class="nav-text">故障模拟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DDL操作"><span class="nav-number">3.9.</span> <span class="nav-text">DDL操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GTID"><span class="nav-number">3.10.</span> <span class="nav-text">GTID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题点"><span class="nav-number">3.11.</span> <span class="nav-text">问题点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单主模式和多主模式切换"><span class="nav-number">4.</span> <span class="nav-text">单主模式和多主模式切换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关参考"><span class="nav-number">5.</span> <span class="nav-text">相关参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guosong</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("9kcST9vPJNzYBSHm66Q3hGTs-gzGzoHsz", "mptvYpkmzqyHsKU0t4fAgzlt");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
